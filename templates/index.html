{% extends "base.html" %}

{% block title %}PDF Wisdom Chatbot{% endblock %}

{% block head %}
<style>
    /* Message styles */
    .message {
        max-width: 85%;
        padding: 12px 16px;
        border-radius: 10px;
        margin-bottom: 8px;
    }
    
    .user-message {
        background-color: #e0f2fe;
        border: 1px solid #bae6fd;
        margin-left: auto;
    }
    
    .bot-message {
        background-color: white;
        border: 1px solid #e2e8f0;
        margin-right: auto;
    }
    
    /* Visualization panel */
    .visualization-panel {
        transition: max-height 0.3s ease, opacity 0.3s ease;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }
    
    .visualization-panel.active {
        max-height: 600px;
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col lg:flex-row gap-6 h-[calc(100vh-180px)]">
    <!-- Chat section -->
    <div class="flex-1 flex flex-col bg-white rounded-lg shadow-soft overflow-hidden border border-gray-200">
        <!-- Chat header -->
        <div class="p-4 border-b border-gray-200 bg-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-medium text-secondary-900">Wisdom Assistant</h2>
                        <p class="text-sm text-secondary-500">Ask me anything from your PDFs</p>
                    </div>
                </div>
                <div>
                    <span id="status-indicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8">
                            <circle cx="4" cy="4" r="3" />
                        </svg>
                        Online
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Chat messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
            <!-- Welcome message -->
            <div class="message bot-message slide-in">
                <p class="text-secondary-800">
                    Hello! I'm your Wisdom Assistant. I can help you find answers from your PDF knowledge base.
                    Ask me any question, and I'll search through your documents to find the most relevant information.
                </p>
            </div>
            <!-- Messages will be added here dynamically -->
        </div>
        
        <!-- Chat input -->
        <div class="p-4 border-t border-gray-200 bg-white">
            <form id="question-form" class="flex space-x-2">
                <input 
                    type="text" 
                    id="question-input" 
                    placeholder="Ask a question..." 
                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                    required
                >
                <button 
                    type="submit" 
                    class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Visualization section -->
    <div id="visualization-container" class="lg:w-1/3 xl:w-2/5 flex flex-col bg-white rounded-lg shadow-soft overflow-hidden border border-gray-200 hidden lg:flex">
        <!-- Visualization header -->
        <div class="p-4 border-b border-gray-200 bg-white">
            <h2 class="text-lg font-medium text-secondary-900">Search Visualization</h2>
            <p class="text-sm text-secondary-500">See how the vector search works</p>
        </div>
        
        <!-- Visualization content -->
        <div class="flex-1 overflow-y-auto p-4">
            <!-- Tabs -->
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-6">
                    <button id="tab-decomposition" class="tab-button border-primary-500 text-primary-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Decomposition
                    </button>
                    <button id="tab-search" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Search Results
                    </button>
                    <button id="tab-similarity" class="tab-button border-transparent text-secondary-500 hover:text-secondary-700 hover:border-secondary-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Similarity
                    </button>
                </nav>
            </div>
            
            <!-- Tab content -->
            <div class="mt-4 space-y-4">
                <!-- Decomposition view -->
                <div id="view-decomposition" class="tab-content">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h3 class="font-medium text-secondary-900 mb-2">Question Analysis</h3>
                        <p id="question-analysis" class="text-sm text-secondary-700 mb-4">Ask a question to see the analysis</p>
                        
                        <h3 class="font-medium text-secondary-900 mb-2">Sub-questions</h3>
                        <ul id="sub-questions-list" class="list-disc pl-5 text-sm text-secondary-700 mb-4">
                            <li>Sub-questions will appear here</li>
                        </ul>
                        
                        <h3 class="font-medium text-secondary-900 mb-2">Key Concepts</h3>
                        <ul id="concepts-list" class="list-disc pl-5 text-sm text-secondary-700">
                            <li>Key concepts will appear here</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Search results view -->
                <div id="view-search" class="tab-content hidden">
                    <div id="search-results" class="space-y-3">
                        <p class="text-sm text-secondary-500">Ask a question to see search results</p>
                    </div>
                </div>
                
                <!-- Similarity visualization view -->
                <div id="view-similarity" class="tab-content hidden">
                    <div id="similarity-chart" class="h-80">
                        <!-- Plotly chart will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // DOM elements
    const questionForm = document.getElementById('question-form');
    const questionInput = document.getElementById('question-input');
    const chatMessages = document.getElementById('chat-messages');
    const statusIndicator = document.getElementById('status-indicator');
    const visualizationContainer = document.getElementById('visualization-container');
    
    // Tab navigation
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Visualization elements
    const questionAnalysis = document.getElementById('question-analysis');
    const subQuestionsList = document.getElementById('sub-questions-list');
    const conceptsList = document.getElementById('concepts-list');
    const searchResults = document.getElementById('search-results');
    const similarityChart = document.getElementById('similarity-chart');
    
    // Check service health
    async function checkHealth() {
        try {
            const response = await fetch('/api/health');
            const data = await response.json();
            
            if (data.status === 'ok') {
                statusIndicator.innerHTML = `
                    <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-green-400" fill="currentColor" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="3" />
                    </svg>
                    Online
                `;
                statusIndicator.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
            } else {
                statusIndicator.innerHTML = `
                    <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-red-400" fill="currentColor" viewBox="0 0 8 8">
                        <circle cx="4" cy="4" r="3" />
                    </svg>
                    Offline
                `;
                statusIndicator.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
            }
        } catch (error) {
            console.error('Health check failed:', error);
            statusIndicator.innerHTML = `
                <svg class="-ml-0.5 mr-1.5 h-2 w-2 text-yellow-400" fill="currentColor" viewBox="0 0 8 8">
                    <circle cx="4" cy="4" r="3" />
                </svg>
                Unknown
            `;
            statusIndicator.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
        }
    }
    
    // Add a message to the chat
    function addMessage(content, isUser = false) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isUser ? 'user-message' : 'bot-message'} slide-in`;
        
        // For longer messages with markdown-like formatting
        if (!isUser && content.includes('\n')) {
            // Simple markdown-like rendering for bot messages
            const formattedContent = content
                .replace(/\n\n/g, '</p><p>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n- /g, '<br>â€¢ ');
                
            messageElement.innerHTML = `<p class="text-secondary-800">${formattedContent}</p>`;
        } else {
            messageElement.innerHTML = `<p class="text-secondary-800">${content}</p>`;
        }
        
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Add a typing indicator
    function addTypingIndicator() {
        const typingElement = document.createElement('div');
        typingElement.id = 'typing-indicator';
        typingElement.className = 'message bot-message slide-in';
        typingElement.innerHTML = `
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        `;
        chatMessages.appendChild(typingElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Remove typing indicator
    function removeTypingIndicator() {
        const typingElement = document.getElementById('typing-indicator');
        if (typingElement) {
            typingElement.remove();
        }
    }
    
    // Handle form submission
    questionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) return;
        
        // Add user message
        addMessage(question, true);
        
        // Clear input
        questionInput.value = '';
        
        // Show typing indicator
        addTypingIndicator();
        
        // Show visualization on mobile
        visualizationContainer.classList.remove('hidden');
        visualizationContainer.classList.add('flex');
        
        try {
            // Send question to API
            const response = await fetch('/api/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question })
            });
            
            const data = await response.json();
            
            // Remove typing indicator
            removeTypingIndicator();
            
            if (data.error) {
                addMessage('Sorry, I encountered an error: ' + data.error);
            } else {
                // Add bot response
                addMessage(data.answer);
                
                // Update visualization
                updateVisualization(data);
            }
        } catch (error) {
            console.error('Error:', error);
            removeTypingIndicator();
            addMessage('Sorry, something went wrong. Please try again later.');
        }
    });
    
    // Update visualization with data
    function updateVisualization(data) {
        // Update decomposition view
        if (data.decomposition) {
            questionAnalysis.textContent = data.decomposition.analysis || 'No analysis available';
            
            // Update sub-questions
            subQuestionsList.innerHTML = '';
            if (data.decomposition.sub_questions && data.decomposition.sub_questions.length > 0) {
                data.decomposition.sub_questions.forEach(question => {
                    const li = document.createElement('li');
                    li.textContent = question;
                    li.className = 'text-sm text-secondary-700 mb-1';
                    subQuestionsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No sub-questions identified';
                li.className = 'text-sm text-secondary-500';
                subQuestionsList.appendChild(li);
            }
            
            // Update concepts
            conceptsList.innerHTML = '';
            if (data.decomposition.concepts && data.decomposition.concepts.length > 0) {
                data.decomposition.concepts.forEach(concept => {
                    const li = document.createElement('li');
                    if (typeof concept === 'string') {
                        li.textContent = concept;
                    } else if (concept.name && concept.description) {
                        li.innerHTML = `<strong>${concept.name}:</strong> ${concept.description}`;
                    }
                    li.className = 'text-sm text-secondary-700 mb-1';
                    conceptsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.textContent = 'No key concepts identified';
                li.className = 'text-sm text-secondary-500';
                conceptsList.appendChild(li);
            }
        }
        
        // Update search results view
        if (data.visualization) {
            searchResults.innerHTML = '';
            
            data.visualization.forEach(query => {
                // Create query group
                const queryGroup = document.createElement('div');
                queryGroup.className = 'mb-4';
                
                // Query header
                const queryHeader = document.createElement('h3');
                queryHeader.className = 'text-sm font-medium text-secondary-900 mb-2';
                queryHeader.textContent = `Query: "${query.query}"`;
                queryGroup.appendChild(queryHeader);
                
                if (query.results && query.results.length > 0) {
                    // Results list
                    const resultsList = document.createElement('div');
                    resultsList.className = 'space-y-2';
                    
                    query.results.forEach((result, index) => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'p-3 bg-gray-50 rounded border border-gray-200 text-sm';
                        
                        // Format based on type
                        let content = '';
                        
                        if (result.type === 'concept') {
                            content = `
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-secondary-900">${result.label}</span>
                                    <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full">${(result.score * 100).toFixed(1)}%</span>
                                </div>
                                <p class="text-secondary-700">${result.content}</p>
                                <p class="text-xs text-secondary-500 mt-1">Source: ${result.source}</p>
                            `;
                        } else if (result.type === 'qa_pair' || result.type === 'question') {
                            content = `
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-secondary-900">Q: ${result.label}</span>
                                    <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full">${(result.score * 100).toFixed(1)}%</span>
                                </div>
                                <p class="text-secondary-700">A: ${result.content}</p>
                                <p class="text-xs text-secondary-500 mt-1">Source: ${result.source}</p>
                            `;
                        } else {
                            content = `
                                <div class="flex justify-between items-start mb-1">
                                    <span class="font-medium text-secondary-900">Text</span>
                                    <span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full">${(result.score * 100).toFixed(1)}%</span>
                                </div>
                                <p class="text-secondary-700">${result.content}</p>
                                <p class="text-xs text-secondary-500 mt-1">Source: ${result.source}</p>
                            `;
                        }
                        
                        resultItem.innerHTML = content;
                        resultsList.appendChild(resultItem);
                    });
                    
                    queryGroup.appendChild(resultsList);
                } else {
                    // No results message
                    const noResults = document.createElement('p');
                    noResults.className = 'text-sm text-secondary-500 p-3 bg-gray-50 rounded border border-gray-200';
                    noResults.textContent = 'No results found for this query';
                    queryGroup.appendChild(noResults);
                }
                
                searchResults.appendChild(queryGroup);
            });
        }
        
        // Update similarity chart view
        if (data.visualization) {
            // Prepare data for similarity chart
            const chartData = [];
            
            // Get top results across all queries
            const allResults = [];
            data.visualization.forEach(query => {
                if (query.results) {
                    query.results.forEach(result => {
                        if (!allResults.some(r => r.id === result.id)) {
                            allResults.push({
                                id: result.id,
                                label: result.label || result.id,
                                similarity: result.score,
                                source: result.source,
                                type: result.type
                            });
                        }
                    });
                }
            });
            
            // Sort by similarity and take top 10
            allResults.sort((a, b) => b.similarity - a.similarity);
            const topResults = allResults.slice(0, 10);
            
            // Prepare bar chart data
            const labels = topResults.map(r => r.label.length > 30 ? r.label.substring(0, 30) + '...' : r.label);
            const values = topResults.map(r => r.similarity);
            const colors = topResults.map(r => {
                switch(r.type) {
                    case 'concept': return 'rgba(14, 165, 233, 0.7)';  // primary-500
                    case 'qa_pair': return 'rgba(168, 85, 247, 0.7)';  // accent-500
                    case 'question': return 'rgba(168, 85, 247, 0.7)'; // accent-500
                    default: return 'rgba(100, 116, 139, 0.7)';        // secondary-500
                }
            });
            
            // Create bar chart
            Plotly.newPlot('similarity-chart', [{
                x: values,
                y: labels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: colors
                },
                text: topResults.map(r => `${(r.similarity * 100).toFixed(1)}%`),
                textposition: 'auto',
                hoverinfo: 'text',
                hovertext: topResults.map(r => `${r.label}<br>Type: ${r.type}<br>Source: ${r.source}<br>Similarity: ${(r.similarity * 100).toFixed(1)}%`)
            }], {
                title: 'Top 10 Most Similar Results',
                margin: { l: 150, r: 10, t: 40, b: 30 },
                xaxis: {
                    title: 'Similarity Score',
                    range: [0, 1]
                },
                yaxis: {
                    automargin: true
                }
            }, {
                responsive: true
            });
        }
    }
    
    // Tab switching
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Update active tab button
            tabButtons.forEach(btn => {
                btn.classList.remove('border-primary-500', 'text-primary-600');
                btn.classList.add('border-transparent', 'text-secondary-500', 'hover:text-secondary-700', 'hover:border-secondary-300');
            });
            button.classList.remove('border-transparent', 'text-secondary-500', 'hover:text-secondary-700', 'hover:border-secondary-300');
            button.classList.add('border-primary-500', 'text-primary-600');
            
            // Show the corresponding tab content
            const tabId = button.id.replace('tab-', 'view-');
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');
        });
    });
    
    // Initial health check
    checkHealth();
    
    // Periodic health check every 60 seconds
    setInterval(checkHealth, 60000);
</script>
{% endblock %} 